<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניפטי - משחק החנויות שמשגע את המדינה!</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Open Graph Tags for Social Sharing -->
    <meta property="og:title" content="ניפטי - משחק החנויות שמשגע את המדינה!">
    <meta property="og:description" content="הקימו חנות טלגרם אישית בקלות, התחילו להרוויח עוד היום והצטרפו למהפכה הדיגיטלית!">
    <meta property="og:image" content="https://osifeu-prog.github.io/my-shop-landing/nifty_logo.png?v=2">
    <meta property="og:url" content="https://osifeu-prog.github.io/my-shop-landing/">
    <meta property="og:type" content="website">
    <meta property="og:image:width" content="500">
    <meta property="og:image:height" content="500">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://osifeu-prog.github.io/my-shop-landing/nifty_logo.png?v=2">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --accent-color: #6f42c1;
            --text-color: #343a40;
            --light-text: #f8f9fa;
            --bg-color-light: #f8f9fa;
            --bg-color-dark: #212529;
            --gradient-light: linear-gradient(135deg, #e0f2f7, #c6e7f2);
            --gradient-dark: linear-gradient(135deg, #1f2733, #0a0e14);
        }
        body {
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color-light);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            text-align: right;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }
        .hero-section {
            text-align: center;
            padding: 100px 20px;
            background: var(--gradient-light);
            border-bottom-left-radius: 70px;
            border-bottom-right-radius: 70px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 10% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, rgba(40, 167, 69, 0.1) 0%, transparent 50%);
            animation: bg-animate 20s infinite alternate;
        }
        @keyframes bg-animate {
            0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            100% { transform: scale(1.1) rotate(5deg); opacity: 1; }
        }
        .hero-content {
            position: relative;
            z-index: 2;
        }
        .hero-section h1 {
            font-size: 3.5em;
            font-weight: 900;
            color: var(--primary-color);
            margin: 0 0 15px 0;
            animation: fadeInDown 1s ease-out;
        }
        .hero-section p {
            font-size: 1.4em;
            color: var(--text-color);
            max-width: 700px;
            margin: 0 auto 30px auto;
            animation: fadeInUp 1.5s ease-out;
        }
        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            animation: zoomIn 1s ease-out 1.2s forwards;
            opacity: 0;
        }
        .cta-button {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 30px;
            font-weight: 700;
            font-size: 1.1em;
            border-radius: 50px;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .cta-button.telegram-bot {
            background-color: var(--primary-color);
        }
        .cta-button.registration-bot {
            background-color: var(--accent-color);
        }
        .cta-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }
        .cta-button.telegram-bot:hover {
            background-color: #0056b3;
        }
        .cta-button.contact-me:hover {
            background-color: #218838;
        }
        .cta-button.registration-bot:hover {
            background-color: #5d34a5;
        }
        .section {
            padding: 80px 0;
            text-align: center;
        }
        .section-title {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--accent-color);
            margin-bottom: 50px;
            position: relative;
            animation: fadeInDown 1s ease-out;
        }
        .section-title::after {
            content: '';
            display: block;
            width: 100px;
            height: 5px;
            background: var(--primary-color);
            margin: 15px auto 0;
            border-radius: 5px;
        }
        .content-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            text-align: right;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        .content-box.dark-summary {
            background-color: var(--bg-color-dark);
            color: var(--light-text);
        }
        .content-box p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        .content-box strong {
            color: var(--primary-color);
        }
        .content-box.dark-summary strong {
             color: var(--secondary-color);
        }
        .grid-container {
            display: grid;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .grid-item {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
            animation: zoomIn 1s ease-out forwards;
            opacity: 0;
        }
        .grid-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        .grid-item h3 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.3em;
            margin-top: 0;
        }
        .grid-item p {
            color: #555;
        }
        .recruitment-section .grid-item h3 {
            color: var(--secondary-color);
        }
        .testimonials-section {
            padding: 80px 0;
            text-align: center;
        }
        .testimonial-grid {
            display: grid;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            justify-content: center;
        }
        .testimonial-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            text-align: right;
            transition: transform 0.3s ease;
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        .testimonial-card:hover {
            transform: translateY(-5px);
        }
        .testimonial-card .quote {
            font-size: 1.1em;
            font-style: italic;
            margin-bottom: 15px;
            color: #555;
        }
        .testimonial-card .author {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
        }
        .testimonial-card .bot-link {
            display: block;
            margin-top: 10px;
            color: var(--secondary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .testimonial-card .bot-link:hover {
            color: var(--primary-color);
        }
        .testimonial-card .bot-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
        }
        .testimonial-card .bot-info .bot-name {
            font-weight: bold;
        }

        .image-section {
            padding: 50px 0;
            text-align: center;
        }
        .main-image {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            transition: transform 0.5s ease-in-out;
            animation: zoomIn 1.5s ease-out forwards;
            opacity: 0;
        }
        .main-image:hover {
            transform: scale(1.05);
        }

        /* Referral Contest Section */
        .referral-contest-section {
            padding: 80px 0;
            background-color: var(--bg-color-dark);
            color: var(--light-text);
            text-align: center;
        }
        .referral-contest-section h2 {
            color: var(--secondary-color);
        }
        .referral-link-box {
            background-color: #343a40;
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        #referral-link-text {
            color: var(--light-text);
            font-family: monospace;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
        }
        .copy-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        .copy-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .leaderboard-container {
            margin-top: 40px;
            background-color: #343a40;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            margin: 40px auto 0;
        }
        .leaderboard-container h3 {
            color: var(--light-text);
            font-size: 1.5em;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #495057;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-item .rank {
            font-weight: bold;
            color: var(--accent-color);
        }
        .leaderboard-item .user-id {
            font-family: monospace;
            font-size: 0.9em;
            direction: ltr; /* Ensure left-to-right for user IDs */
        }
        .leaderboard-item .count {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        /* Animations */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @media (max-width: 768px) {
            .hero-section h1 { font-size: 2.5em; }
            .hero-section p { font-size: 1.1em; }
            .cta-buttons { flex-direction: column; gap: 15px; }
            .cta-button { width: 80%; margin: 0 auto; }
            .section-title { font-size: 2em; }
        }
    </style>
</head>
<body>
    <header class="hero-section">
        <div class="hero-content">
            <h1>ניפטי - משחק החנויות שמשגע את המדינה!</h1>
            <p>ברוכים הבאים לעולם של ניפטי - המקום שבו החלום על קניון אישי הופך למציאות. בניפטי, אנו מאמינים שלכל אחד ואחת מגיע להקים עסק משלו, בקלות וביעילות. הצטרפו למהפכה הדיגיטלית החדשה והתחילו להרוויח עוד היום.</p>
            <div class="cta-buttons">
                <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button telegram-bot">
                    <i class="fab fa-telegram-plane"></i> כנסו לחנות שלי בטלגרם
                </a>
                <a href="https://t.me/OsifFin" target="_blank" class="cta-button contact-me">
                    <i class="fas fa-comments"></i> דברו איתי ישירות
                </a>
            </div>
        </div>
    </header>
    <main>
        <section class="section what-is-nifty">
            <div class="container">
                <h2 class="section-title">מה זה ניפטי?</h2>
                <div class="content-box">
                    <p><strong>ניפטי</strong> הוא משחק וחוויה עסקית שמאפשרת לכם להקים חנות אישית בתוך פלטפורמת טלגרם. במקום להשקיע אלפי שקלים בפיתוח אתרים או שכירות פיזית, בניפטי אתם רוכשים חנות דיגיטלית משלכם ומקבלים שליטה מלאה על מה שאתם מוכרים.</p>
                    <p><strong>דמיינו זאת כך:</strong> אתם רוכשים חנות בקניון הענק של טלגרם, הופכים אותה לייחודית רק לכם, ומתחילים למכור.</p>
                    <div class="block-cta">
                        <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button">
                             כנסו עכשיו לחנות בטלגרם <i class="fab fa-telegram-plane"></i>
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section image-section">
            <div class="container">
                 <img src="https://osifeu-prog.github.io/my-shop-landing/c0190e32-af92-45f5-9d50-131da2550659.jpeg" alt="אריה צבעוני עם מגן דוד" class="main-image">
            </div>
        </section>

        <section class="section how-it-works">
            <div class="container">
                <h2 class="section-title">איך זה עובד?</h2>
                <div class="grid-container">
                    <div class="grid-item">
                        <h3><i class="fas fa-shopping-cart"></i> רכישת חנות</h3>
                        <p>כל משתתף רוכש חנות דיגיטלית בטלגרם בעלות של 189 ₪.</p>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-key"></i> קבלת טוקן לבוט</h3>
                        <p>מיד עם הרכישה, תקבלו טוקן ייחודי להפעלת החנות האישית שלכם.</p>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-paint-brush"></i> עיצוב והתאמה אישית</h3>
                        <p>עצבו את גלריית המוצרים שלכם, שנו תמונות, תיאורים ומחירים בקלות.</p>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-rocket"></i> התחלת מכירות</h3>
                        <p>התחילו למכור בקלות וקבלו את הרווחים ישירות לחשבון הבנק שלכם.</p>
                    </div>
                </div>
                <div class="block-cta">
                    <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button">
                         התחילו לבנות חנות משלכם <i class="fab fa-telegram-plane"></i>
                        </a>
                    </div>
                </div>
        </section>
        <section class="section">
            <div class="profit-section">
                <h2 class="section-title">מנגנון הרווח והכספים</h2>
                <p>כל המכירות מתבצעות דרך החנות שלכם, הכוללת גם מערכת קבלות מבוססות NFT לתיעוד דיגיטלי. והכי חשוב?</p>
                <p><strong>כל העברה כספית מאומתת מחשבון הלקוח עוברת <span style="color: var(--secondary-color);">ישירות לחשבון הבנק שלכם!</span> הרווח כולו שלכם.</strong></p>
                <div class="block-cta">
                    <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button">
                         התחילו להרוויח היום <i class="fab fa-telegram-plane"></i>
                    </a>
                </div>
            </div>
        </section>
        <section class="section recruitment-section">
            <div class="container">
                <h2 class="section-title">אשמח לעבוד איתך</h2>
                <p>אנחנו תמיד מחפשים שותפים חדשים עם תשוקה לחדשנות, למכירות, ולפיתוחים טכנולוגיים. אם אתם מעוניינים להצטרף לצוות שלנו או להגדיל את הקהילה - צרו קשר!</p>
                <div class="grid-container">
                    <div class="grid-item">
                        <h3><i class="fas fa-laptop-code"></i> מפתחים</h3>
                        <p>בואו לבנות איתנו את הדור הבא של הבוטים לטלגרם.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-chart-line"></i> אנשי מכירות</h3>
                        <p>הצטרפו אלינו והרוויחו עמלות על כל חנות שתמכרו.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-users"></i> מנהלי קהילה</h3>
                        <p>עזרו לנו לגדול ולהפיץ את הבשורה של ניפטי.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item">
                        <h3><i class="fas fa-bullhorn"></i> משווקים שותפים</h3>
                        <p>הפכו לשותפים שלנו וקבלו אחוזים מכל לקוח חדש שתביאו.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Existing section for customer testimonials -->
        <section class="section testimonials-section">
            <div class="container">
                <h2 class="section-title">פידבק מלקוחות</h2>
                <div class="testimonial-grid" id="testimonials-container">
                    <!-- Testimonials will be dynamically added here by JavaScript -->
                </div>
            </div>
        </section>
        
        <!-- New Referral Contest Section -->
        <section class="section referral-contest-section">
            <div class="container">
                <h2 class="section-title">תחרות השיתופים הגדולה!</h2>
                <p>שתפו את הקישור הייחודי שלכם וצבורו נקודות על כל חבר חדש שמצטרף דרככם. המשתתף שיצבור את מירב ההפניות בסוף השבוע יזכה בפלטפורמה בחינם!</p>

                <div class="referral-stats">
                    <p style="font-size: 1.2em; font-weight: bold;">
                        <i class="fas fa-trophy"></i>
                        הקישור האישי שלך לזכייה:
                    </p>
                    <div class="referral-link-box">
                        <span id="referral-link-text">...</span>
                        <button id="copy-button" class="copy-button">
                            <i class="fas fa-copy"></i>
                            העתק קישור
                        </button>
                    </div>
                    <p style="font-weight: bold;">
                        <i class="fas fa-user-plus"></i> מספר החברים שהבאת:
                        <span id="referral-count">0</span>
                    </p>
                     <p style="font-size: 0.9em;">
                        מזהה משתמש ייחודי: <span id="user-id">...</span>
                    </p>
                </div>

                <div class="leaderboard-container">
                    <h3><i class="fas fa-chart-bar"></i> לוח אלופים</h3>
                    <div id="leaderboard">
                        <div class="leaderboard-item">
                            <span class="rank">#1</span>
                            <span class="user-id">טוען...</span>
                            <span class="count">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 NIFTY. כל הזכויות שמורות. נבנה באהבה עבור קהילת המשקיעים של סלה ללא גבולות. מטבע הקריפטו שיושק בקרוב על גבי פלטפורמה זו. <a href="https://t.me/OsifFin" target="_blank" style="color: var(--primary-color); text-decoration: none;">צרו איתי קשר כאן</a>.</p>
        </div>
        <!-- New Registration Bot Button -->
        <div style="text-align: center; padding: 20px 0;">
            <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button registration-bot">
                <i class="fas fa-user-plus"></i> הרשמה לבוט
            </a>
        </div>
    </footer>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Logging for debugging
        setLogLevel('debug');

        // Main app logic
        document.addEventListener('DOMContentLoaded', async function() {
            // General scroll animations
            const faders = document.querySelectorAll('.content-box, .grid-item, .profit-section, .testimonial-card, .main-image, .referral-contest-section');
            const appearOptions = {
                threshold: 0.2,
                rootMargin: "0px 0px -50px 0px"
            };
            const appearOnScroll = new IntersectionObserver(function(entries, appearOnScroll) {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        return;
                    } else {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        entry.target.style.animationPlayState = 'running';
                        appearOnScroll.unobserve(entry.target);
                    }
                });
            }, appearOptions);
            faders.forEach(fader => {
                fader.style.opacity = '0';
                fader.style.transform = 'translateY(20px)';
                fader.style.animationPlayState = 'paused';
                appearOnScroll.observe(fader);
            });

            // Testimonials logic
            const testimonialsContainer = document.getElementById('testimonials-container');
            const testimonials = [
                {
                    author: "אביב הכהן",
                    feedback: "הופתעתי לטובה מהקלות שבה הקמתי את החנות. הממשק פשוט, אינטואיטיבי, ואני כבר רואה תוצאות!",
                    botName: "בוט הפריטים של אביב",
                    botLink: "https://t.me/aviv_bot",
                    icon: "fas fa-box"
                },
                {
                    author: "רונית מזרחי",
                    feedback: "הקונספט של חנות בטלגרם הוא גאוני. זה חיסכון בזמן ובכסף, והשירות מדהים.",
                    botName: "בוט האופנה של רונית",
                    botLink: "https://t.me/ronit_fashion_bot",
                    icon: "fas fa-tshirt"
                },
                {
                    author: "דניאל לוי",
                    feedback: "הפיצ'ר של הקבלות מבוססות NFT הוא שיגעון. זה נותן לי שקט נפשי ויכולת לעקוב אחרי הכל בקלות.",
                    botName: "בוט המכירות של דניאל",
                    botLink: "https://t.me/daniel_sales_bot",
                    icon: "fas fa-chart-line"
                }
            ];

            function renderTestimonials() {
                testimonialsContainer.innerHTML = '';
                testimonials.forEach(testimonial => {
                    const card = document.createElement('div');
                    card.className = 'testimonial-card';
                    card.innerHTML = `
                        <p class="quote">"${testimonial.feedback}"</p>
                        <p class="author">- ${testimonial.author}</p>
                        <a href="${testimonial.botLink}" target="_blank" class="bot-link">
                            <i class="${testimonial.icon}"></i> <span class="bot-name">${testimonial.botName}</span>
                        </a>
                    `;
                    testimonialsContainer.appendChild(card);
                });
            }

            renderTestimonials();

            // Firebase and Referral Contest Logic
            const referralLinkTextElement = document.getElementById('referral-link-text');
            const referralCountElement = document.getElementById('referral-count');
            const userIdElement = document.getElementById('user-id');
            const copyButton = document.getElementById('copy-button');
            const leaderboardElement = document.getElementById('leaderboard');
            
            let db, auth, userId;
            let isAuthReady = false;

            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                return;
            }

            // Authentication state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User authenticated with UID:", userId);
                    initializeReferralTracking();
                } else {
                    // Try to sign in with custom token or anonymously
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // If auth fails, use a temporary ID for basic functionality
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                        console.log("Authentication failed, using temporary ID:", userId);
                        initializeReferralTracking();
                    }
                }
            });

            async function initializeReferralTracking() {
                if (!isAuthReady) return;

                // Check for referral link in the URL
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('ref');
                console.log("Referrer ID from URL:", referrerId);

                // Update Firestore if a user was referred
                if (referrerId && referrerId !== userId) {
                    const referrerDocRef = doc(db, `artifacts/${appId}/public/data/referrals/${referrerId}`);
                    try {
                        const referrerDoc = await getDoc(referrerDocRef);
                        const currentCount = referrerDoc.exists() ? referrerDoc.data().count : 0;
                        await setDoc(referrerDocRef, { count: currentCount + 1, lastReferred: new Date().toISOString() }, { merge: true });
                        console.log(`Referral from ${userId} successfully recorded for ${referrerId}`);
                    } catch (error) {
                        console.error("Error updating referrer count:", error);
                    }
                }

                // Display user's unique link and ID
                const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userId}`;
                referralLinkTextElement.textContent = referralLink;
                userIdElement.textContent = userId;

                // Listen for real-time updates to the current user's referral count
                const userDocRef = doc(db, `artifacts/${appId}/public/data/referrals/${userId}`);
                onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        referralCountElement.textContent = data.count || 0;
                    } else {
                        referralCountElement.textContent = 0;
                        console.log("No referral data found for this user.");
                    }
                }, (error) => {
                    console.error("Error listening to user doc:", error);
                });

                // Listen for real-time updates to the leaderboard
                const referralsColl = collection(db, `artifacts/${appId}/public/data/referrals`);
                onSnapshot(referralsColl, async (snapshot) => {
                    const allReferrals = [];
                    snapshot.forEach(doc => {
                        allReferrals.push({
                            id: doc.id,
                            count: doc.data().count || 0
                        });
                    });

                    // Sort the referrals by count descending and take the top 10
                    allReferrals.sort((a, b) => b.count - a.count);
                    const topTen = allReferrals.slice(0, 10);
                    
                    // Render the leaderboard
                    leaderboardElement.innerHTML = '';
                    if (topTen.length === 0) {
                        leaderboardElement.innerHTML = '<p style="text-align: center; color: #888;">התחרות עדיין לא התחילה! היה/תה הראשון/ה!</p>';
                    } else {
                        topTen.forEach((item, index) => {
                            const leaderboardItem = document.createElement('div');
                            leaderboardItem.classList.add('leaderboard-item');
                            leaderboardItem.innerHTML = `
                                <span class="rank">#${index + 1}</span>
                                <span class="user-id">${item.id}</span>
                                <span class="count">${item.count}</span>
                            `;
                            leaderboardElement.appendChild(leaderboardItem);
                        });
                    }
                }, (error) => {
                    console.error("Error listening to leaderboard:", error);
                });
            }

            // Copy button logic
            copyButton.addEventListener('click', () => {
                const link = referralLinkTextElement.textContent;
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    console.log('Referral link copied to clipboard!');
                    copyButton.textContent = 'הועתק!';
                    setTimeout(() => {
                        copyButton.innerHTML = '<i class="fas fa-copy"></i> העתק קישור';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(tempInput);
            });
        });
    </script>
</body>
</html>
