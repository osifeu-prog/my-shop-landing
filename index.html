<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניפטי - משחק החנויות שמשגע את המדינה!</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter', 'Heebo', 'sans-serif'],
              },
              colors: {
                primary: '#007bff',
                secondary: '#28a745',
                accent: '#6f42c1',
                textColor: '#343a40',
                lightText: '#f8f9fa',
                bgColorLight: '#f8f9fa',
                bgColorDark: '#212529',
              }
            }
          }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Open Graph Tags for Social Sharing -->
    <meta property="og:title" content="ניפטי - משחק החנויות שמשגע את המדינה!">
    <meta property="og:description" content="הקימו חנות טלגרם אישית בקלות, התחילו להרוויח עוד היום והצטרפו למהפכה הדיגיטלית!">
    <meta property="og:image" content="https://osifeu-prog.github.io/my-shop-landing/nifty_logo.png?v=2">
    <meta property="og:url" content="https://osifeu-prog.github.io/my-shop-landing/">
    <meta property="og:type" content="website">
    <meta property="og:image:width" content="500">
    <meta property="og:image:height" content="500">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://osifeu-prog.github.io/my-shop-landing/nifty_logo.png?v=2">
    
    <style>
        body {
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            line-height: 1.6;
            color: #343a40;
            background-color: #f8f9fa;
        }
        .hero-section {
            background: linear-gradient(135deg, #e0f2f7, #c6e7f2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 10% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, rgba(40, 167, 69, 0.1) 0%, transparent 50%);
            animation: bg-animate 20s infinite alternate;
        }
        @keyframes bg-animate {
            0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            100% { transform: scale(1.1) rotate(5deg); opacity: 1; }
        }
        .cta-button {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            font-weight: 700;
            font-size: 1.1em;
            border-radius: 50px;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .cta-button.telegram-bot { background-color: #007bff; }
        .cta-button.registration-bot { background-color: #6f42c1; }
        .cta-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }
        
        .social-login-button {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .social-login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .hero-section h1 { font-size: 2.5em; }
            .hero-section p { font-size: 1.1em; }
            .cta-buttons { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body class="bg-gray-50 text-right">
    <header class="hero-section text-center py-20 lg:py-40 rounded-b-[70px] relative overflow-hidden">
        <div class="relative z-10 px-4">
            <h1 class="text-4xl lg:text-6xl font-extrabold text-primary mb-4 animate-fadeInDown">ניפטי - משחק החנויות שמשגע את המדינה!</h1>
            <p class="text-lg lg:text-xl text-gray-700 max-w-3xl mx-auto mb-8 animate-fadeInUp">
                ברוכים הבאים לעולם של ניפטי - המקום שבו החלום על קניון אישי הופך למציאות. בניפטי, אנו מאמינים שלכל אחד ואחת מגיע להקים עסק משלו, בקלות וביעילות. הצטרפו למהפכה הדיגיטלית החדשה והתחילו להרוויח עוד היום.
            </p>
            <div class="flex flex-col md:flex-row justify-center gap-4 mt-8 animate-zoomIn">
                <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button telegram-bot">
                    <i class="fab fa-telegram-plane"></i> כנסו לחנות שלי בטלגרם
                </a>
                <a href="https://t.me/OsifFin" target="_blank" class="cta-button bg-secondary hover:bg-green-600">
                    <i class="fas fa-comments"></i> דברו איתי ישירות
                </a>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-4">
        <!-- Social Login Section -->
        <section class="py-16 text-center" id="auth-section">
            <div class="content-box bg-white p-8 rounded-2xl shadow-xl animate-fadeInUp" id="auth-box">
                <h2 class="text-2xl font-bold text-accent mb-4">התחברו כדי לשתף ולהתחרות!</h2>
                <p class="text-gray-600 mb-6">התחברו באמצעות אחד החשבונות הבאים כדי לקבל קישור אישי ולעקוב אחר ההפניות שלכם.</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="google-login-btn" class="social-login-button bg-gray-50 text-textColor px-6 py-3 rounded-full shadow-lg flex items-center justify-center gap-2 font-bold transition-all">
                        <i class="fab fa-google text-red-500 text-lg"></i> התחבר עם Google
                    </button>
                    <!-- Buttons for other providers as a placeholder -->
                    <button class="social-login-button bg-gray-50 text-textColor px-6 py-3 rounded-full shadow-lg flex items-center justify-center gap-2 font-bold opacity-50 cursor-not-allowed">
                        <i class="fab fa-tiktok text-black text-lg"></i> התחבר עם TikTok
                    </button>
                    <button class="social-login-button bg-gray-50 text-textColor px-6 py-3 rounded-full shadow-lg flex items-center justify-center gap-2 font-bold opacity-50 cursor-not-allowed">
                        <i class="fab fa-facebook text-blue-700 text-lg"></i> התחבר עם Facebook
                    </button>
                </div>
                <div id="login-error-message" class="text-red-500 mt-4 hidden"></div>
            </div>
        </section>

        <!-- Referral Contest Section -->
        <section class="py-16 bg-gray-900 text-white rounded-2xl shadow-xl mt-8 animate-fadeInUp hidden" id="referral-contest-section">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-4xl font-extrabold text-secondary mb-4">תחרות השיתופים הגדולה!</h2>
                <p class="text-lg text-gray-300 mb-8">
                    שתפו את הקישור הייחודי שלכם וצבורו נקודות על כל חבר חדש שמצטרף דרככם. המשתתף שיצבור את מירב ההפניות בסוף השבוע יזכה בפלטפורמה בחינם!
                </p>
                
                <div id="user-profile" class="flex flex-col items-center gap-4 mb-8">
                    <img id="profile-picture" class="w-24 h-24 rounded-full border-4 border-secondary shadow-lg" src="https://placehold.co/100x100/A0A0A0/FFFFFF?text=?" alt="תמונת פרופיל">
                    <h3 class="text-2xl font-bold text-lightText" id="user-name">טוען משתמש...</h3>
                    <div class="text-sm text-gray-400">
                        <p>מזהה משתמש ייחודי: <span id="user-id">...</span></p>
                    </div>
                </div>

                <div class="referral-stats mb-8">
                    <div class="text-2xl font-bold text-secondary flex items-center justify-center gap-2 mb-2">
                        <i class="fas fa-trophy"></i>
                        <span>הקישור האישי שלך לזכייה:</span>
                    </div>
                    <div class="referral-link-box bg-gray-800 p-4 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4 w-full max-w-xl mx-auto">
                        <span id="referral-link-text" class="text-lightText font-mono text-sm text-left overflow-hidden whitespace-nowrap text-ellipsis flex-grow">...</span>
                        <button id="copy-button" class="copy-button bg-primary text-white py-2 px-6 rounded-full font-bold shadow-lg flex-shrink-0 hover:bg-blue-600 transition-colors duration-300">
                            <i class="fas fa-copy ml-2"></i>
                            העתק קישור
                        </button>
                    </div>
                    <p class="text-xl font-bold mt-4">
                        <i class="fas fa-user-plus text-primary"></i> מספר החברים שהבאת:
                        <span id="referral-count" class="text-secondary">0</span>
                    </p>
                </div>

                <div class="leaderboard-container bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-xl mx-auto">
                    <h3 class="text-2xl font-bold text-lightText border-b-2 border-accent pb-2 mb-4 flex items-center justify-center gap-2">
                        <i class="fas fa-chart-bar"></i> לוח אלופים
                    </h3>
                    <div id="leaderboard">
                        <div class="leaderboard-item flex justify-between items-center py-2 text-gray-300 border-b border-gray-700 last:border-b-0">
                            <span class="rank font-bold text-accent">#1</span>
                            <div class="flex items-center gap-2">
                                <img src="https://placehold.co/32x32/A0A0A0/FFFFFF?text=?" class="w-8 h-8 rounded-full" />
                                <span class="user-profile-name text-lightText font-semibold">טוען...</span>
                            </div>
                            <span class="count font-bold text-secondary">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Existing sections remain here for continuity -->
        <section class="section what-is-nifty py-16 text-center">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-extrabold text-accent mb-12 relative after:content-[''] after:block after:w-24 after:h-1 after:bg-primary after:rounded after:mt-4 after:mx-auto">מה זה ניפטי?</h2>
                <div class="content-box bg-white p-8 rounded-3xl shadow-lg text-right animate-fadeInUp">
                    <p class="text-lg text-gray-700 mb-4"><strong>ניפטי</strong> הוא משחק וחוויה עסקית שמאפשרת לכם להקים חנות אישית בתוך פלטפורמת טלגרם. במקום להשקיע אלפי שקלים בפיתוח אתרים או שכירות פיזית, בניפטי אתם רוכשים חנות דיגיטלית משלכם ומקבלים שליטה מלאה על מה שאתם מוכרים.</p>
                    <p class="text-lg text-gray-700 mb-4"><strong>דמיינו זאת כך:</strong> אתם רוכשים חנות בקניון הענק של טלגרם, הופכים אותה לייחודית רק לכם, ומתחילים למכור.</p>
                    <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button telegram-bot mt-8 mx-auto">
                        כנסו עכשיו לחנות בטלגרם <i class="fab fa-telegram-plane ml-2"></i>
                    </a>
                </div>
            </div>
        </section>
        
        <section class="section image-section py-12 text-center">
            <div class="container mx-auto px-4">
                <img src="https://osifeu-prog.github.io/my-shop-landing/c0190e32-af92-45f5-9d50-131da2550659.jpeg" alt="אריה צבעוני עם מגן דוד" class="main-image w-full max-w-xl mx-auto rounded-3xl shadow-2xl animate-zoomIn">
            </div>
        </section>

        <section class="section how-it-works py-16 text-center">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-extrabold text-accent mb-12 relative after:content-[''] after:block after:w-24 after:h-1 after:bg-primary after:rounded after:mt-4 after:mx-auto">איך זה עובד?</h2>
                <div class="grid-container grid gap-8 md:grid-cols-2 lg:grid-cols-4">
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-primary mb-2"><i class="fas fa-shopping-cart"></i> רכישת חנות</h3>
                        <p class="text-gray-600">כל משתתף רוכש חנות דיגיטלית בטלגרם בעלות של 189 ₪.</p>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-primary mb-2"><i class="fas fa-key"></i> קבלת טוקן לבוט</h3>
                        <p class="text-gray-600">מיד עם הרכישה, תקבלו טוקן ייחודי להפעלת החנות האישית שלכם.</p>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-primary mb-2"><i class="fas fa-paint-brush"></i> עיצוב והתאמה אישית</h3>
                        <p class="text-gray-600">עצבו את גלריית המוצרים שלכם, שנו תמונות, תיאורים ומחירים בקלות.</p>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-primary mb-2"><i class="fas fa-rocket"></i> התחלת מכירות</h3>
                        <p class="text-gray-600">התחילו למכור בקלות וקבלו את הרווחים ישירות לחשבון הבנק שלכם.</p>
                    </div>
                </div>
                <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button mt-12 mx-auto">
                    התחילו לבנות חנות משלכם <i class="fab fa-telegram-plane ml-2"></i>
                </a>
            </div>
        </section>

        <section class="section py-16 text-center">
            <h2 class="text-3xl font-extrabold text-accent mb-8 relative after:content-[''] after:block after:w-24 after:h-1 after:bg-primary after:rounded after:mt-4 after:mx-auto">מנגנון הרווח והכספים</h2>
            <p class="text-lg text-gray-700 mb-4">כל המכירות מתבצעות דרך החנות שלכם, הכוללת גם מערכת קבלות מבוססות NFT לתיעוד דיגיטלי. והכי חשוב?</p>
            <p class="text-xl font-bold text-textColor mb-8">
                <strong>כל העברה כספית מאומתת מחשבון הלקוח עוברת <span class="text-secondary">ישירות לחשבון הבנק שלכם!</span> הרווח כולו שלכם.</strong>
            </p>
            <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button mt-8 mx-auto">
                התחילו להרוויח היום <i class="fab fa-telegram-plane ml-2"></i>
            </a>
        </section>

        <section class="section recruitment-section py-16 text-center">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-extrabold text-accent mb-8 relative after:content-[''] after:block after:w-24 after:h-1 after:bg-primary after:rounded after:mt-4 after:mx-auto">אשמח לעבוד איתך</h2>
                <p class="text-lg text-gray-700 mb-8">אנחנו תמיד מחפשים שותפים חדשים עם תשוקה לחדשנות, למכירות, ולפיתוחים טכנולוגיים. אם אתם מעוניינים להצטרף לצוות שלנו או להגדיל את הקהילה - צרו קשר!</p>
                <div class="grid-container grid gap-8 md:grid-cols-2 lg:grid-cols-4">
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-secondary mb-2"><i class="fas fa-laptop-code"></i> מפתחים</h3>
                        <p class="text-gray-600">בואו לבנות איתנו את הדור הבא של הבוטים לטלגרם.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button !py-2 !px-4 mt-4 !bg-primary !text-white !font-normal mx-auto">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-secondary mb-2"><i class="fas fa-chart-line"></i> אנשי מכירות</h3>
                        <p class="text-gray-600">הצטרפו אלינו והרוויחו עמלות על כל חנות שתמכרו.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button !py-2 !px-4 mt-4 !bg-primary !text-white !font-normal mx-auto">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-secondary mb-2"><i class="fas fa-users"></i> מנהלי קהילה</h3>
                        <p class="text-gray-600">עזרו לנו לגדול ולהפיץ את הבשורה של ניפטי.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button !py-2 !px-4 mt-4 !bg-primary !text-white !font-normal mx-auto">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                    <div class="grid-item bg-white p-8 rounded-2xl shadow-lg text-center transition-transform hover:translate-y-[-10px] animate-zoomIn">
                        <h3 class="text-xl font-bold text-secondary mb-2"><i class="fas fa-bullhorn"></i> משווקים שותפים</h3>
                        <p class="text-gray-600">הפכו לשותפים שלנו וקבלו אחוזים מכל לקוח חדש שתביאו.</p>
                        <a href="https://t.me/OsifFin" target="_blank" class="cta-button !py-2 !px-4 mt-4 !bg-primary !text-white !font-normal mx-auto">
                            <i class="fas fa-comments"></i> דברו איתי
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section testimonials-section py-16 text-center">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-extrabold text-accent mb-12 relative after:content-[''] after:block after:w-24 after:h-1 after:bg-primary after:rounded after:mt-4 after:mx-auto">פידבק מלקוחות</h2>
                <div class="testimonial-grid grid gap-8 md:grid-cols-2 lg:grid-cols-3" id="testimonials-container">
                    <!-- Testimonials will be dynamically added here by JavaScript -->
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-gray-900 text-lightText py-12 text-center mt-12">
        <div class="container mx-auto px-4">
            <p class="text-sm">&copy; 2025 NIFTY. כל הזכויות שמורות. נבנה באהבה עבור קהילת המשקיעים של סלה ללא גבולות. מטבע הקריפטו שיושק בקרוב על גבי פלטפורמה זו. <a href="https://t.me/OsifFin" target="_blank" class="text-primary hover:underline">צרו איתי קשר כאן</a>.</p>
        </div>
        <div class="text-center pt-8">
            <a href="https://t.me/Buy_My_Shop_bot" target="_blank" class="cta-button registration-bot !py-3 !px-8 text-lg">
                <i class="fas fa-user-plus ml-2"></i> הרשמה לבוט
            </a>
        </div>
    </footer>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Logging for debugging
        setLogLevel('debug');

        // UI Elements
        const authSection = document.getElementById('auth-section');
        const referralContestSection = document.getElementById('referral-contest-section');
        const referralLinkTextElement = document.getElementById('referral-link-text');
        const referralCountElement = document.getElementById('referral-count');
        const userIdElement = document.getElementById('user-id');
        const userNameElement = document.getElementById('user-name');
        const profilePictureElement = document.getElementById('profile-picture');
        const copyButton = document.getElementById('copy-button');
        const leaderboardElement = document.getElementById('leaderboard');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        
        let db, auth;
        let isAuthReady = false;

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
        }

        // Handle Google Login
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Google login successful:", result.user.uid);
            } catch (error) {
                console.error("Google login failed:", error);
                loginErrorMessage.textContent = `ההתחברות באמצעות גוגל נכשלה: ${error.message}`;
                loginErrorMessage.classList.remove('hidden');
            }
        });

        // Authentication state listener - main application logic starts here
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                const userId = user.uid;
                const userName = user.displayName || 'משתמש חדש';
                const userPhotoURL = user.photoURL || 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=?';

                // Check for referral link in the URL.
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('ref');

                // Check if this is a new user login and update Firestore
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    // This is a new user, save their profile data
                    await setDoc(userDocRef, {
                        name: userName,
                        photoURL: userPhotoURL,
                        joinedAt: new Date().toISOString(),
                        referrerId: referrerId || null
                    });

                    console.log("New user profile saved.");

                    // If a referrer ID exists and it's not the user themselves, update the referrer's count.
                    if (referrerId && referrerId !== userId) {
                        const referrerRef = doc(db, `artifacts/${appId}/public/data/referrals/${referrerId}`);
                        const referrerData = await getDoc(referrerRef);
                        const currentCount = referrerData.exists() ? referrerData.data().count : 0;
                        await setDoc(referrerRef, { count: currentCount + 1 }, { merge: true });
                        console.log(`Referral from ${userId} successfully recorded for ${referrerId}`);
                    }
                }

                // UI updates for logged-in user
                authSection.classList.add('hidden');
                referralContestSection.classList.remove('hidden');
                userNameElement.textContent = userName;
                userIdElement.textContent = userId;
                profilePictureElement.src = userPhotoURL;

                // Listen for real-time updates to the current user's referral count
                const userReferralDocRef = doc(db, `artifacts/${appId}/public/data/referrals/${userId}`);
                onSnapshot(userReferralDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        referralCountElement.textContent = data.count || 0;
                    } else {
                        referralCountElement.textContent = 0;
                        console.log("No referral data found for this user.");
                    }
                }, (error) => {
                    console.error("Error listening to user doc:", error);
                });

                // Generate and display the referral link
                const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userId}`;
                referralLinkTextElement.textContent = referralLink;
                
                // Set up the copy button
                copyButton.onclick = async () => {
                    try {
                        // Use the deprecated execCommand for broader compatibility in iframes
                        const tempInput = document.createElement('input');
                        tempInput.value = referralLink;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert('הקישור הועתק בהצלחה!'); // Using alert as a temporary fix for UI feedback
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                };

                // Listen for real-time updates to the leaderboard
                const referralsColl = collection(db, `artifacts/${appId}/public/data/referrals`);
                onSnapshot(referralsColl, async (snapshot) => {
                    const allReferrals = [];
                    snapshot.forEach(doc => {
                        allReferrals.push({
                            id: doc.id,
                            count: doc.data().count || 0
                        });
                    });

                    allReferrals.sort((a, b) => b.count - a.count);
                    const topTen = allReferrals.slice(0, 10);
                    
                    // Fetch user profiles for the leaderboard
                    const userProfilePromises = topTen.map(async (item) => {
                        const userProfileDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users/${item.id}`));
                        const profileData = userProfileDoc.exists() ? userProfileDoc.data() : null;
                        return {
                            ...item,
                            name: profileData?.name || `משתמש #${item.id.substring(0, 5)}`,
                            photoURL: profileData?.photoURL || 'https://placehold.co/32x32/A0A0A0/FFFFFF?text=?'
                        };
                    });

                    const topTenWithProfiles = await Promise.all(userProfilePromises);

                    // Render the leaderboard
                    leaderboardElement.innerHTML = '';
                    if (topTenWithProfiles.length === 0) {
                        leaderboardElement.innerHTML = '<p class="text-center text-gray-400">אין עדיין מובילים בלוח הניקוד. בואו להיות הראשונים!</p>';
                    } else {
                        topTenWithProfiles.forEach((item, index) => {
                            const leaderboardItem = document.createElement('div');
                            leaderboardItem.className = 'leaderboard-item flex justify-between items-center py-2 text-gray-300 border-b border-gray-700 last:border-b-0';
                            leaderboardItem.innerHTML = `
                                <span class="rank font-bold text-accent">#${index + 1}</span>
                                <div class="flex items-center gap-2">
                                    <img src="${item.photoURL}" class="w-8 h-8 rounded-full" />
                                    <span class="user-profile-name text-lightText font-semibold">${item.name}</span>
                                </div>
                                <span class="count font-bold text-secondary">${item.count} הפניות</span>
                            `;
                            leaderboardElement.appendChild(leaderboardItem);
                        });
                    }
                }, (error) => {
                    console.error("Error listening to leaderboard:", error);
                });

            } else {
                // User is signed out.
                // Try to sign in with custom token or anonymously
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    // If auth fails, show the login buttons
                    authSection.classList.remove('hidden');
                    referralContestSection.classList.add('hidden');
                    loginErrorMessage.textContent = `שגיאה בהתחברות: ${error.message}`;
                    loginErrorMessage.classList.remove('hidden');
                }
            }
        });

        // General scroll animations
        document.addEventListener('DOMContentLoaded', function() {
            const faders = document.querySelectorAll('.content-box, .grid-item, .profit-section, .testimonial-card, .main-image');
            const appearOptions = {
                threshold: 0.2,
                rootMargin: "0px 0px -50px 0px"
            };
            const appearOnScroll = new IntersectionObserver(function(entries, appearOnScroll) {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        return;
                    } else {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        entry.target.style.animationPlayState = 'running';
                        appearOnScroll.unobserve(entry.target);
                    }
                });
            }, appearOptions);
            faders.forEach(fader => {
                fader.style.opacity = '0';
                fader.style.transform = 'translateY(20px)';
                fader.style.animationPlayState = 'paused';
                appearOnScroll.observe(fader);
            });

            // Testimonials logic
            const testimonialsContainer = document.getElementById('testimonials-container');
            const testimonials = [
                {
                    author: "אביב הכהן",
                    feedback: "הופתעתי לטובה מהקלות שבה הקמתי את החנות. הממשק פשוט, אינטואיטיבי, ואני כבר רואה תוצאות!",
                    botName: "בוט הפריטים של אביב",
                    botLink: "https://t.me/aviv_bot",
                    icon: "fas fa-box"
                },
                {
                    author: "רונית מזרחי",
                    feedback: "הקונספט של חנות בטלגרם הוא גאוני. זה חיסכון בזמן ובכסף, והשירות מדהים.",
                    botName: "בוט האופנה של רונית",
                    botLink: "https://t.me/ronit_fashion_bot",
                    icon: "fas fa-tshirt"
                },
                {
                    author: "דניאל לוי",
                    feedback: "הפיצ'ר של הקבלות מבוססות NFT הוא שיגעון. זה נותן לי שקט נפשי ויכולת לעקוב אחרי הכל בקלות.",
                    botName: "בוט המכירות של דניאל",
                    botLink: "https://t.me/daniel_sales_bot",
                    icon: "fas fa-chart-line"
                }
            ];
            
            testimonials.forEach(testimonial => {
                const card = document.createElement('div');
                card.className = 'testimonial-card bg-white p-8 rounded-2xl shadow-lg text-right transition-transform hover:translate-y-[-5px] animate-fadeInUp';
                card.innerHTML = `
                    <p class="quote text-lg italic text-gray-600 mb-4">"${testimonial.feedback}"</p>
                    <p class="author font-bold text-primary mt-2">- ${testimonial.author}</p>
                    <a href="${testimonial.botLink}" target="_blank" class="bot-link block mt-2 text-secondary hover:text-primary transition-colors duration-300">
                        <i class="${testimonial.icon}"></i> <span class="bot-name font-bold">${testimonial.botName}</span>
                    </a>
                `;
                testimonialsContainer.appendChild(card);
            });
        });

    </script>
</body>
</html>
